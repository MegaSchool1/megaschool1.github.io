@using MegaSchool1.Model
@using OneOf
@using OneOf.Types
@inherits Components.ComponentBase

<div style="display:@_display;">
    @if (ValidYouTube && Video.IsT1)
    {
        <iframe @onload="OnVideoLoaded"
                src="@($"{Constants.YouTubeEmbedLinkPrefix}{YouTube}")"
                width="560"
                height="315"
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen>
        </iframe>
    }

    @if (ValidTikTok && Video.IsT1)
    {
        <blockquote class="tiktok-embed" cite="https://www.tiktok.com/@@@(this.TikTok?.UserHandle)/video/@TikTok" data-video-id="@TikTok.Value.VideoId" style="max-width: 605px;min-width: 300px;">
            <section></section>
        </blockquote>
        <script async src="https://www.tiktok.com/embed.js"></script>
    }

    @if (ValidVimeo && Video.IsT1)
    {
        <iframe src="@($"https://player.vimeo.com/video/{Vimeo?.VideoId}{(string.IsNullOrWhiteSpace(Vimeo?.Hash) ? string.Empty : $"?h={Vimeo?.Hash}")}")" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen="" data-ready="true"></iframe>
    }
    
    @if (ValidFacebook && Video.IsT1)
    {
        <iframe src="https://www.facebook.com/plugins/video.php?height=314&href=https%3A%2F%2Fwww.facebook.com%2F@(Facebook?.ChannelId)%2Fvideos%2F@(Facebook?.VideoId)%2F&show_text=false&width=560&t=0" width="560" height="314" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>
    }
    
    @(Video.Match<RenderFragment?>(
        video => video.Match<RenderFragment>(
            youTube => YouTubeView(youTube),
            tikTok => TikTokView(tikTok),
            vimeo => VimeoView(vimeo),
            facebook => FacebookView(facebook),
            startMeeting => StartMeetingView(startMeeting),
            html5 => Html5View(html5)),
        none => null))
</div>

@if (!_iframeLoaded)
{
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="auto" Height="100px;" />
}
@code {
    private bool _iframeLoaded;
    private string _display = "none";

    [Parameter]
    public string? YouTube { get; set; }

    [Parameter]
    public (string UserHandle, string VideoId)? TikTok { get; set; }

    /// <summary>
    ///     Hash - Required for private Vimeo videos. See https://www.drupal.org/project/video_embed_field/issues/3238136
    /// </summary>
    [Parameter]
    public (string VideoId, string? Hash)? Vimeo { get; set; }

    [Parameter]
    public (string ChannelId, string VideoId)? Facebook { get; set; }

    [Parameter]
    public OneOf<Video, None> Video { get; set; } = new None();

    private bool ValidYouTube => !string.IsNullOrWhiteSpace(YouTube);
    private bool ValidVimeo => !string.IsNullOrWhiteSpace(Vimeo?.VideoId);
    private bool ValidTikTok => !string.IsNullOrWhiteSpace(TikTok?.UserHandle) && !string.IsNullOrWhiteSpace(TikTok?.VideoId);
    private bool ValidFacebook => !string.IsNullOrWhiteSpace(Facebook?.ChannelId) && !string.IsNullOrWhiteSpace(Facebook?.VideoId);

    private RenderFragment YouTubeView(YouTube youTube) => __builder =>
    {
        <iframe @onload="OnVideoLoaded"
                src="@($"{Constants.YouTubeEmbedLinkPrefix}{youTube.VideoId}")"
                width="560"
                height="315"
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen>
        </iframe>
    };

    private RenderFragment TikTokView(TikTok tikTok) => __builder =>
    {
        <blockquote class="tiktok-embed" cite="https://www.tiktok.com/@@@(tikTok.UserHandle)/video/@tikTok.VideoId" data-video-id="@tikTok.VideoId" style="max-width: 605px;min-width: 300px;">
            <section></section>
        </blockquote>
        <script async src="https://www.tiktok.com/embed.js"></script>
    };

    private RenderFragment VimeoView(Vimeo vimeo) => __builder =>
    {
        <iframe src="@($"https://player.vimeo.com/video/{vimeo.VideoId}{vimeo.Hash.Match(hash => $"?h={hash}", none => string.Empty)}")" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen="" data-ready="true"></iframe>
    };

    private RenderFragment FacebookView(Facebook facebook) => __builder =>
    {
        <iframe src="https://www.facebook.com/plugins/video.php?height=314&href=https%3A%2F%2Fwww.facebook.com%2F@(facebook.ChannelId)%2Fvideos%2F@(facebook.VideoId)%2F&show_text=false&width=560&t=0" width="560" height="314" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>
    };

    private RenderFragment StartMeetingView(StartMeeting startMeeting) => __builder =>
    {
        <iframe allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" src="https://stme.in/@startMeeting.VideoId" scrolling="no" frameborder="0" height="300" width="538"></iframe>
    };

    private RenderFragment Html5View(Html5 html5) => __builder =>
    {
        <video width="100%" controls>
            <source src="@html5.Uri.AbsoluteUri" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    };

    protected override void OnParametersSet()
    {
        if(Video.TryPickT0(out var video, out var _))
        {
            this.YouTube = video.IsT0 ? video.AsT0.VideoId : null;
            this.TikTok = video.IsT1 ? (video.AsT1.UserHandle, video.AsT1.VideoId) : null;
            this.Vimeo = video.IsT2 ? (video.AsT2.VideoId, video.AsT2.Hash.Match(hash => hash, none => (string?)null)) : null;
            this.Facebook = video.IsT3 ? (video.AsT3.ChannelId, video.AsT3.VideoId) : null;
        }
  
        if (Video.IsT0 || ValidYouTube || ValidTikTok || ValidVimeo || ValidFacebook)
        {
            this.ShowVideo();
        }
    }

    private void OnVideoLoaded(ProgressEventArgs e)
    {
        this.ShowVideo();
    }

    private void ShowVideo()
    {
        _iframeLoaded = true;
        _display = "block";
    }
}
